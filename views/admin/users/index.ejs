<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <%- include('../../partials/navbar', { user: user }) %>

    <h2><%= title %></h2>

    <form method="GET" action="/admin/users">
      <input
        type="text"
        name="search"
        placeholder="Search..."
        value="<%= search %>"
      />
      <button type="submit">Search</button>
    </form>

    <a href="/admin/users/new">Create New User</a>

    <table border="1">
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
      <% users.forEach(user => { %>
      <tr>
        <td><%= user.user_id %></td>
        <td><%= user.username %></td>
        <td><%= user.email %></td>
        <td><%= user.Role ? user.Role.role_name : '' %></td>
        <td>
          <a href="/admin/users/<%= user.user_id %>/edit">Edit</a>

          <% isSelf = (user.user_id === currentUserId); const isAdmin =
          (user.Role && user.Role.role_name === 'admin'); %> <% if (!isSelf) {
          %> <% if (isAdmin && adminCount === 1) { %>
          <button disabled title="Cannot delete the last remaining admin">
            Delete
          </button>
          <% } else { %>
          <form
            method="POST"
            action="/admin/users/<%= user.user_id %>/delete"
            style="display: inline"
          >
            <button
              type="submit"
              onclick="return confirm('Delete this user?');"
            >
              Delete
            </button>
          </form>
          <% } %> <% } %>
        </td>
      </tr>
      <% }); %>
    </table>

    <% if(totalPages > 1) { %>
    <div>
      <% for(let p = 1; p <= totalPages; p++) { %> <% if(p === currentPage) { %>
      <strong><%= p %></strong>
      <% } else { %>
      <a href="?page=<%= p %>&search=<%= search %>"><%= p %></a>
      <% } %> <% } %>
    </div>
    <% } %>
  </body>
</html>
